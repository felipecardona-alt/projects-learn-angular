name: CI & Deploy

on:
	push:
		branches:
			- master
			- feature/*
	pull_request:
		branches:
			- master

jobs:
	build:
		runs-on: ubuntu-latest
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Setup Node
				uses: actions/setup-node@v4
				with:
					node-version: 20
					cache: 'npm'

			- name: Install dependencies
				run: npm ci

			- name: Lint
				run: npm run lint --if-present

			- name: Test
				run: npm test -- --watch=false --browsers=ChromeHeadless || npm test -- --watch=false

			- name: Build
				run: npm run build -- --configuration=production

			- name: Upload build artifact
				uses: actions/upload-artifact@v4
				with:
					name: dist
					path: dist/**

	deploy:
		if: github.ref == 'refs/heads/master'
		needs: build
		runs-on: ubuntu-latest
		steps:
			- name: Download build artifact
				uses: actions/download-artifact@v4
				with:
					name: dist
					path: dist

			- name: Deploy to GitHub Pages
				uses: peaceiris/actions-gh-pages@v3
				with:
					github_token: ${{ secrets.GITHUB_TOKEN }}
					publish_dir: dist
					force_orphan: true

